<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login con Google - Biblioteca UTH</title>

<style>
body{
    font-family:'Segoe UI',Tahoma;
    background:linear-gradient(135deg,#667eea,#764ba2);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
}

.container{
    background:white;
    padding:40px;
    border-radius:15px;
    box-shadow:0 10px 40px rgba(0,0,0,.2);
    max-width:600px;
    width:100%;
}

.loading{text-align:center}

.spinner{
    border:4px solid #eee;
    border-top:4px solid #667eea;
    border-radius:50%;
    width:50px;
    height:50px;
    animation:spin 1s linear infinite;
    margin:auto;
}

@keyframes spin{
from{transform:rotate(0)}
to{transform:rotate(360deg)}
}

.result{
display:none;
margin-top:20px;
padding:20px;
border-radius:10px;
}

.success{background:#d4edda}
.error{background:#f8d7da}

.user-info{
background:#f0f4ff;
padding:15px;
border-radius:10px;
margin-top:15px;
}

.token{
background:#222;
color:#4ec9b0;
padding:10px;
border-radius:8px;
margin-top:15px;
word-break:break-all;
}

img{
border-radius:50%;
margin-top:10px;
}
</style>
</head>

<body>

<div class="container">

<h2>üîê Login con Google</h2>

<div id="loading" class="loading">
<div class="spinner"></div>
<p>Procesando autenticaci√≥n...</p>
</div>

<div id="result" class="result"></div>

</div>


<script>
document.addEventListener("DOMContentLoaded",()=>{

const params=new URLSearchParams(window.location.search);

const accessToken=params.get("access_token");
const refreshToken=params.get("refresh_token");
const userInfo=params.get("user_info");
const googleInfo=params.get("google_info");
const code=params.get("code");
const error=params.get("error");


/* =============================
   LOGIN EXITOSO (YA REGRES√ì DJANGO)
=============================*/
if(accessToken){

localStorage.setItem("access_token",accessToken);
localStorage.setItem("refresh_token",refreshToken);

let user=null;
let google=null;

if(userInfo){
user=JSON.parse(decodeURIComponent(userInfo));
localStorage.setItem("user_info",JSON.stringify(user));
}

if(googleInfo){
google=JSON.parse(decodeURIComponent(googleInfo));
localStorage.setItem("google_info",JSON.stringify(google));
}

showSuccess(user,google,accessToken);
return;
}


/* =============================
   ERROR
=============================*/
if(error){
showError(error);
return;
}


/* =============================
   PEDIR LOGIN GOOGLE
=============================*/
if(!code){
window.location.href="/api/auth/google/redirect/";
return;
}


/* =============================
   INTERCAMBIO CODE
=============================*/
exchangeCode(code);

});



/* =============================
   CALLBACK MANUAL
=============================*/
async function exchangeCode(code){

try{

const res=await fetch("/api/auth/google/callback/",{
method:"POST",
headers:{
"Content-Type":"application/json"
},
body:JSON.stringify({code})
});

const data=await res.json();

if(!res.ok){
showError(data.error||"Error OAuth");
return;
}

showSuccess(data.user,data.google_data,data.access);

}catch(e){
showError(e.message);
}

}



/* =============================
   SUCCESS UI
=============================*/
function showSuccess(user,google,token){

document.getElementById("loading").style.display="none";

const div=document.getElementById("result");
div.className="result success";
div.style.display="block";

div.innerHTML=`
<h3>‚úÖ Login exitoso con Google</h3>

<div class="user-info">
<p><b>Email:</b> ${user?.email||""}</p>
<p><b>Nombre:</b> ${user?.first_name||""} ${user?.last_name||""}</p>
<p><b>Username:</b> ${user?.username||""}</p>

${google?.picture ?
`<img src="${google.picture}" width="90">`
:""}
</div>

<div class="token">
<b>JWT:</b><br>
${token.substring(0,60)}...
</div>

<br>
<a href="/api/">üìö Ir a API</a>
`;
}



/* =============================
   ERROR UI
=============================*/
function showError(msg){

document.getElementById("loading").style.display="none";

const div=document.getElementById("result");
div.className="result error";
div.style.display="block";

div.innerHTML=`
<h3>‚ùå Error</h3>
<p>${msg}</p>
`;
}
</script>

</body>
</html>